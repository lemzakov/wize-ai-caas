name: Build dist zip

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  dist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: repo

      - name: Debug files exist in repo
        run: |
          set -eux
          cd repo
          ls -la
          test -f Dockerfile
          test -f package.json
          test -f pnpm-lock.yaml
          test -f pnpm-workspace.yaml
          test -d patches
          test -f docker-compose.yml || true
          test -f .env.example || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Temporarily disable .dockerignore (it excludes required files)
        run: |
          set -eux
          cd repo
          if [ -f .dockerignore ]; then
            echo "---- .dockerignore (head) ----"
            sed -n '1,200p' .dockerignore || true
            mv .dockerignore .dockerignore.bak
          fi

      - name: Build Docker image from Dockerfile (verbose)
        run: |
          set -eux
          cd repo
          docker build --progress=plain -f Dockerfile -t wize:v1 .

      - name: Restore .dockerignore
        if: always()
        run: |
          set -eux
          cd repo
          if [ -f .dockerignore.bak ]; then
            mv .dockerignore.bak .dockerignore
          fi

      - name: Export Docker image to tar
        run: |
          set -eux
          docker save -o wize_image.tar wize:v1

      - name: Prepare dist folder
        run: |
          set -eux
          cd repo
          mkdir -p DIST

          cp docker-compose.yml DIST/ 2>/dev/null || true
          cp .env.example DIST/ 2>/dev/null || true
          cp QUICKSTART.md DIST/ 2>/dev/null || true
          cp DEPLOYMENT.md DIST/ 2>/dev/null || true
          cp DEFAULT_WORKFLOWS_MANUAL_RU.md DIST/ 2>/dev/null || true

          cp -r default-workflows DIST/ 2>/dev/null || true
          cp -r docker DIST/ 2>/dev/null || true

          mv ../wize_image.tar DIST/

          cat << 'EOF' > DIST/README_INSTALL.txt
          Установка:
          1) Установите Docker и Docker Compose.
          2) В папке с дистрибутивом выполните:

          docker load -i wize_image.tar
          cp .env.example .env
          docker compose up -d

          Открыть:
          - адрес и порт смотрите в docker-compose.yml (часто http://localhost:5678)
          EOF

      - name: Zip dist
        run: |
          set -eux
          cd repo
          (cd DIST && zip -r ../WIZE_DIST.zip .)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: WIZE_DIST
          path: repo/WIZE_DIST.zip

      - name: Create GitHub Release (only on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: repo/WIZE_DIST.zip
