name: Build dist zip (no build)

on:
  workflow_dispatch:

jobs:
  dist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: repo

      - name: Prepare dist folder (no docker build)
        run: |
          set -eux
          cd repo

          mkdir -p DIST

          # Основные файлы деплоя
          cp docker-compose.yml DIST/ 2>/dev/null || true
          cp docker-compose.dev.yml DIST/ 2>/dev/null || true
          cp Dockerfile DIST/ 2>/dev/null || true
          cp .env.example DIST/ 2>/dev/null || true
          cp .dockerignore DIST/ 2>/dev/null || true

          # Документация (у тебя её много — отлично)
          cp README.md DIST/ 2>/dev/null || true
          cp QUICKSTART.md DIST/ 2>/dev/null || true
          cp GETTING_STARTED.md DIST/ 2>/dev/null || true
          cp DEPLOYMENT.md DIST/ 2>/dev/null || true
          cp DEPLOYMENT_CHECKLIST.md DIST/ 2>/dev/null || true
          cp DEPLOYMENT_SUMMARY.md DIST/ 2>/dev/null || true
          cp IMPLEMENTATION_SUMMARY.md DIST/ 2>/dev/null || true
          cp DEFAULT_WORKFLOWS_MANUAL_RU.md DIST/ 2>/dev/null || true

          # Важные папки (по твоему списку)
          cp -r docker DIST/ 2>/dev/null || true
          cp -r default-workflows DIST/ 2>/dev/null || true
          cp -r packages DIST/ 2>/dev/null || true
          cp -r patches DIST/ 2>/dev/null || true
          cp -r scripts DIST/ 2>/dev/null || true
          cp -r assets DIST/ 2>/dev/null || true

          # Корневые файлы сборки монорепы
          cp package.json DIST/ 2>/dev/null || true
          cp pnpm-lock.yaml DIST/ 2>/dev/null || true
          cp pnpm-workspace.yaml DIST/ 2>/dev/null || true
          cp turbo.json DIST/ 2>/dev/null || true
          cp tsconfig.json DIST/ 2>/dev/null || true

          # Инструкция для эксперта
          cat << 'EOF' > DIST/README_INSTALL.txt
          Дистрибутив сформирован из файлов репозитория (без предсобранных образов).

          Запуск (требуется Docker + Docker Compose):
          1) cp .env.example .env
          2) docker compose up -d --build

          Примечание:
          - состав и параметры смотрите в docker-compose.yml и DEPLOYMENT.md
          EOF

          (cd DIST && zip -r ../WIZE_DIST.zip .)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: WIZE_DIST
          path: repo/WIZE_DIST.zip
